<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.literature.chat.mapper.ChatSessionMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.literature.chat.entity.ChatSession">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="type" property="type"/>
        <result column="status" property="status"/>
        <result column="created_by" property="createdBy"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        id, title, type, status, created_by, created_at, updated_at
    </sql>

    <!-- 分页搜索会话 -->
    <select id="searchSessions" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM chat_sessions
        <where>
            <if test="keyword != null and keyword != ''">
                AND title LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
        </where>
        ORDER BY updated_at DESC
    </select>

    <!-- 查询用户参与的会话 -->
    <select id="selectByMemberUserId" resultMap="BaseResultMap">
        SELECT s.*
        FROM chat_sessions s
        INNER JOIN chat_session_members m ON s.id = m.session_id
        WHERE m.user_id = #{userId}
        <if test="status != null and status != ''">
            AND s.status = #{status}
        </if>
        ORDER BY s.updated_at DESC
    </select>

    <!-- 查询两个用户之间的私聊会话 -->
    <select id="selectPrivateSession" resultMap="BaseResultMap">
        SELECT s.*
        FROM chat_sessions s
        INNER JOIN chat_session_members m1 ON s.id = m1.session_id
        INNER JOIN chat_session_members m2 ON s.id = m2.session_id
        WHERE s.type = 'private'
          AND m1.user_id = #{user1}
          AND m2.user_id = #{user2}
        LIMIT 1
    </select>

</mapper>
